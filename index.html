<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가치 있는 일상: 프리미엄 스마트 플래너</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 80px; transition: all 0.2s; cursor: pointer; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        .calendar-day:hover { background-color: #f8fafc; }
        .day-today { background-color: #eff6ff !important; border: 2px solid #3b82f6 !important; border-radius: 12px; z-index: 10; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .loader { width: 16px; height: 16px; border: 2px solid #e2e8f0; border-bottom-color: #4f46e5; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- 개발자 정보 배너 -->
    <div class="bg-indigo-700 text-white py-3 px-4 text-center shadow-lg z-[60] border-b border-indigo-800">
        <div class="max-w-6xl mx-auto flex items-center justify-center gap-3">
            <div class="bg-white/20 p-1 rounded-lg">
                <i data-lucide="award" class="w-5 h-5 text-yellow-300"></i>
            </div>
            <span class="text-sm sm:text-base font-black tracking-tight">
                개발자: 가치있는 미래교육 연구소 대표 <span class="text-yellow-300 underline underline-offset-4">김병찬</span>
            </span>
        </div>
    </div>

    <!-- 로그인/코드 입력 화면 -->
    <div id="loginSection" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-4">
        <div class="bg-white w-full max-w-md rounded-[3rem] shadow-2xl p-12 animate-slide-up">
            <div class="text-center mb-10">
                <div class="inline-flex p-5 bg-indigo-50 text-indigo-600 rounded-[2rem] mb-6 shadow-inner">
                    <i data-lucide="sparkles" class="w-12 h-12"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter mb-2">가치 있는 일상</h1>
                <p class="text-slate-500 text-sm font-medium leading-relaxed">나만의 고유 코드를 입력하여<br><span class="text-indigo-600 font-bold">프리미엄 스마트 플래너를 시작하세요.</span></p>
            </div>
            <div class="space-y-5">
                <div class="relative">
                    <i data-lucide="key-round" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                    <input type="password" id="userCodeInput" placeholder="비밀 코드를 입력하세요" 
                           class="w-full pl-14 pr-6 py-5 bg-slate-50 border border-slate-200 rounded-3xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none text-center text-xl font-black tracking-[0.3em] transition-all">
                </div>
                <button onclick="handleLogin()" id="loginBtn" disabled class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-xl hover:bg-indigo-700 transition-all flex items-center justify-center gap-3 shadow-xl shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="loginBtnText">시작하기</span>
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="authStatusContainer" class="mt-8 flex flex-col items-center justify-center gap-2">
                <div class="flex items-center gap-2">
                    <span id="statusSpinner" class="loader"></span>
                    <p id="authStatusText" class="text-[12px] text-slate-400 font-bold tracking-tight">
                        보안 서버와 연결 중...
                    </p>
                </div>
                <button id="retryBtn" onclick="location.reload()" class="hidden text-[11px] text-indigo-600 font-bold underline mt-2">연결 재시도</button>
            </div>
        </div>
    </div>

    <!-- 메인 대시보드 (로그인 후 표시) -->
    <div id="mainDashboard" class="hidden max-w-7xl mx-auto py-10 px-6 w-full flex-grow animate-slide-up">
        <header class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
            <div class="flex items-center gap-4">
                <div class="p-4 bg-indigo-600 text-white rounded-[1.5rem] shadow-2xl shadow-indigo-200">
                    <i data-lucide="layout-grid" class="w-8 h-8"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter text-indigo-600">가치 있는 일상</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-[10px] font-black rounded-md uppercase">Premium</span>
                        <p class="text-[11px] text-slate-400 font-bold tracking-wider">MEMBER ID: <span id="displayUserCode" class="text-indigo-600 underline"></span></p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3 bg-white p-2 rounded-3xl shadow-sm border border-slate-100">
                <button onclick="changeMonth(-1)" class="p-3 hover:bg-slate-50 rounded-2xl transition-all text-slate-600"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <h3 id="calendarMonth" class="px-6 font-black text-slate-800 min-w-[180px] text-center text-xl tracking-tighter"></h3>
                <button onclick="changeMonth(1)" class="p-3 hover:bg-slate-50 rounded-2xl transition-all text-slate-600"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                <div class="w-px h-8 bg-slate-200 mx-2"></div>
                <button onclick="location.reload()" class="p-3 text-rose-500 hover:bg-rose-50 rounded-2xl transition-all" title="로그아웃"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
            <!-- 캘린더 영역 -->
            <div class="xl:col-span-2 bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col">
                <div class="calendar-grid bg-slate-50/50 border-b border-slate-100">
                    <div class="py-5 text-center text-xs font-black text-rose-500 uppercase tracking-widest">Sun</div>
                    <div class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Mon</div>
                    <div class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Tue</div>
                    <div class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Wed</div>
                    <div class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Thu</div>
                    <div class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Fri</div>
                    <div class="py-5 text-center text-xs font-black text-blue-500 uppercase tracking-widest">Sat</div>
                </div>
                <div id="calendarBody" class="calendar-grid flex-grow"></div>
            </div>

            <!-- 사이드바 -->
            <div class="space-y-8">
                <!-- 등록 폼 -->
                <div class="bg-white rounded-[3rem] shadow-sm border border-slate-100 p-10">
                    <h4 class="font-black text-slate-900 mb-8 flex items-center gap-3 text-xl tracking-tighter">
                        <i data-lucide="calendar-plus" class="w-7 h-7 text-indigo-600"></i> 새로운 계획 추가
                    </h4>
                    <form id="scheduleForm" class="space-y-5">
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">일정명</label>
                            <input type="text" id="title" required placeholder="예: 가치있는 미래교육 미팅" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-[1.5rem] focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 outline-none font-bold text-slate-800 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">날짜</label>
                                <input type="date" id="date" required class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-[1.5rem] text-sm font-black outline-none text-slate-600 transition-all">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">시간</label>
                                <input type="time" id="time" required class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-[1.5rem] text-sm font-black outline-none text-slate-600 transition-all">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">장소</label>
                            <input type="text" id="location" placeholder="어디서 진행되나요?" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-[1.5rem] outline-none text-sm font-bold text-slate-700">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">상세 메모</label>
                            <textarea id="memo" placeholder="세부 내용을 기록하세요." rows="3" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-[1.5rem] outline-none resize-none text-sm font-medium text-slate-700 transition-all"></textarea>
                        </div>
                        <button type="submit" id="saveBtn" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black text-lg hover:bg-black transition-all shadow-2xl shadow-slate-200 active:scale-95 disabled:opacity-50">일정 저장하기</button>
                    </form>
                </div>

                <!-- 일정 리스트 -->
                <div class="bg-indigo-600 rounded-[3rem] shadow-2xl p-10 text-white min-h-[400px]">
                    <div class="flex items-center justify-between mb-8">
                        <h4 class="font-black text-xl tracking-tighter">다가오는 일정</h4>
                        <span id="eventCount" class="bg-white text-indigo-600 px-4 py-1 rounded-full text-xs font-black shadow-lg">0</span>
                    </div>
                    <div id="scheduleList" class="space-y-5 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                        <p id="listEmptyMsg" class="text-indigo-200 text-sm text-center py-12 font-bold italic">새로운 일정을 기다리고 있습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 전역 설정 안전하게 로드
        let firebaseConfig, appId;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'value-planner-pro-v3';
        } catch (e) {
            console.error("Config load error:", e);
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userCode = "";
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let allEvents = [];
        let isAuthReady = false;

        // 초기 아이콘 로드
        lucide.createIcons();

        // 1. 인증 초기화
        async function initAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const authStatusText = document.getElementById('authStatusText');
            const statusSpinner = document.getElementById('statusSpinner');
            const retryBtn = document.getElementById('retryBtn');

            const timeoutId = setTimeout(() => {
                if (!isAuthReady) {
                    authStatusText.innerHTML = "서버 응답이 늦어지고 있습니다.";
                    retryBtn.classList.remove('hidden');
                }
            }, 8000);

            try {
                // 커스텀 토큰 우선 사용
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        clearTimeout(timeoutId);
                        isAuthReady = true;
                        loginBtn.disabled = false;
                        statusSpinner.style.display = 'none';
                        authStatusText.innerText = "서버 연결 성공";
                        authStatusText.classList.replace('text-slate-400', 'text-green-600');
                    }
                });
            } catch (error) {
                console.error("인증 에러:", error);
                authStatusText.innerHTML = "<span class='text-rose-500'>서버 연결 권한 오류</span>";
                retryBtn.classList.remove('hidden');
                statusSpinner.style.display = 'none';
            }
        }
        
        initAuth();

        // 2. 로그인 처리
        window.handleLogin = () => {
            const input = document.getElementById('userCodeInput');
            if (!input.value.trim()) return alert("코드를 입력해 주세요.");
            if (!isAuthReady) return alert("연결 중입니다. 잠시만 기다려주세요.");
            
            userCode = input.value.trim();
            document.getElementById('displayUserCode').innerText = userCode;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            renderCalendar();
            startListening();
        };

        // 3. 실시간 데이터 수신
        function startListening() {
            if (!auth.currentUser) return;
            // RULE 1: 정확한 경로 사용
            const colPath = `/artifacts/${appId}/public/data/user_schedules`;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_schedules');
            
            // RULE 2: 전체 데이터를 가져와 메모리에서 필터링
            onSnapshot(colRef, (snapshot) => {
                allEvents = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(item => item.ownerCode === userCode);
                
                renderCalendar();
                renderScheduleList();
            }, (err) => {
                console.error("Firestore Permission Error:", err);
                alert("데이터 읽기 권한이 없습니다. 관리자에게 문의하세요.");
            });
        }

        // 4. 일정 저장
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('saveBtn');
            if (!auth.currentUser) return;

            saveBtn.disabled = true;
            const originalText = saveBtn.innerText;
            saveBtn.innerText = "저장 중...";

            const newEvent = {
                ownerCode: userCode,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                location: document.getElementById('location').value,
                memo: document.getElementById('memo').value,
                createdAt: Timestamp.now()
            };

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_schedules');
                await addDoc(colRef, newEvent);
                document.getElementById('scheduleForm').reset();
            } catch (err) {
                console.error("Save error:", err);
                alert("저장 실패: 권한이 부족하거나 연결이 끊겼습니다.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = originalText;
            }
        });

        // 5. 일정 삭제
        window.deleteEvent = async (id) => {
            if (!auth.currentUser) return;
            if (!confirm("이 일정을 삭제하시겠습니까?")) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_schedules', id);
                await deleteDoc(docRef);
            } catch (err) {
                console.error("Delete error:", err);
            }
        };

        // --- UI 렌더링 함수들 ---
        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        };

        function renderCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            const monthHeader = document.getElementById('calendarMonth');
            if (!calendarBody || !monthHeader) return;
            
            calendarBody.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            monthHeader.innerText = `${currentYear}년 ${currentMonth + 1}월`;

            // 빈 칸 채우기
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = "calendar-day opacity-20 bg-slate-50/50";
                calendarBody.appendChild(div);
            }

            // 날짜 렌더링
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day;
                const dayOfWeek = new Date(currentYear, currentMonth, day).getDay();
                
                const dayEvents = allEvents.filter(e => e.date === dateStr);
                
                const div = document.createElement('div');
                div.className = `calendar-day p-3 flex flex-col gap-1 overflow-hidden transition-all ${isToday ? 'day-today' : ''}`;
                
                let labelClass = "text-slate-500 font-bold text-sm";
                if (dayOfWeek === 0) labelClass = "text-rose-500 font-black text-sm";
                if (dayOfWeek === 6) labelClass = "text-blue-500 font-black text-sm";
                if (isToday) labelClass = "text-indigo-600 font-black text-lg";

                div.innerHTML = `
                    <span class="${labelClass}">${day}</span>
                    <div class="flex flex-col gap-0.5 overflow-hidden">
                        ${dayEvents.map(e => `
                            <div class="text-[9px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded-md truncate font-black border border-indigo-100">
                                ${e.title}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                div.onclick = () => {
                    document.getElementById('date').value = dateStr;
                    document.getElementById('title').focus();
                };
                calendarBody.appendChild(div);
            }

            // 나머지 칸 채우기
            const totalCells = firstDay + daysInMonth;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < extraCells; i++) {
                const div = document.createElement('div');
                div.className = "calendar-day opacity-20 bg-slate-50/50";
                calendarBody.appendChild(div);
            }
        }

        function renderScheduleList() {
            const listContainer = document.getElementById('scheduleList');
            const eventCount = document.getElementById('eventCount');
            if (!listContainer) return;
            
            const sortedEvents = [...allEvents].sort((a, b) => {
                return new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`);
            });

            eventCount.innerText = sortedEvents.length;

            if (sortedEvents.length === 0) {
                listContainer.innerHTML = `<p class="text-indigo-200 text-sm text-center py-16 font-bold italic">등록된 일정이 없습니다.</p>`;
                return;
            }

            listContainer.innerHTML = sortedEvents.map(e => `
                <div class="bg-white/10 border border-white/20 p-5 rounded-[2rem] flex items-start gap-4 hover:bg-white/20 transition-all group shadow-xl">
                    <div class="flex flex-col items-center justify-center bg-white text-indigo-700 rounded-2xl px-3 py-2 min-w-[60px] shadow-md">
                        <span class="text-[10px] uppercase font-black opacity-60">${new Date(e.date).toLocaleDateString('ko-KR', {weekday: 'short'})}</span>
                        <span class="text-xl font-black">${new Date(e.date).getDate()}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h5 class="font-black truncate text-base text-white tracking-tight">${e.title}</h5>
                        <div class="flex flex-wrap gap-x-3 gap-y-1 mt-2 opacity-90 text-[11px] font-bold text-indigo-50">
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${e.time}</span>
                            ${e.location ? `<span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${e.location}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteEvent('${e.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-white/40 hover:text-rose-200 transition-all">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
        }
    </script>
</body>
</html>
